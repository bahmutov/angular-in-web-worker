<!DOCTYPE html>
<html lang="en">

<head>
</head>

<body>
  <h2>Angular 1.x in Web Worker</h2>
  <p>loads angular in a web worker. The loaded angular will run a digest cycle after 1 second
  and will send rendered HTML to the main browser window (here). To run, load the index.html
  using a local webserver, for example <a href="https://www.npmjs.com/package/http-server">http-server</a>.</p>
  <div id="output">rendered HTML from web worker will replace this text.</div>

  <button id="render" disabled="disabled">Render in Web Worker</button>

  <script src="node_modules/console-log-div/console-log-div.js"></script>
  <script>
    console.log('trying to load angular web worker');
    var worker = new Worker('angular-web-worker.js');

    // app to send to the angular in web worker
    var appDefinition = {
      cmd: 'ngApp',
      // goes to the document.body
      html: '<h1 ng-controller="helloController">Hello {{ title }}</h1>',
      setupApp: function setupApp(angular) {
        angular.module('myApp', [])
          .controller('helloController', ['$scope', function ($scope) {
            $scope.title = 'from Angular ' + angular.version.full + ' running in Web Worker!';
            console.log('changed $scope title to "hello from Angular in web worker"');
          }]);
        return 'myApp';
      },
      renderedApp: function renderedApp(angular) {
        var $timeout = angular.element(document.body).injector().get('$timeout');
        $timeout(function () {
          console.log('after digest cycle body html is');
          console.log(document.body.innerHTML);
          // communicate back to the page
          self.postMessage(document.body.innerHTML);
        });
      }
    };

    worker.onmessage = function (e) {
      console.log('received message from angular web worker');
      if (e.data === 'worker-angular-ready') {
        console.log(e.data);

        var button = document.getElementById('render');
        button.attributes.removeNamedItem('disabled');
        button.addEventListener('click', function () {
          console.log('sending app definition to web worker');

          if (typeof appDefinition.setupApp === 'function') {
            appDefinition.setupApp = appDefinition.setupApp.toString();
          }

          if (typeof appDefinition.renderedApp === 'function') {
            appDefinition.renderedApp = appDefinition.renderedApp.toString();
          }

          worker.postMessage(appDefinition);
        });

      } else {
        console.log('unknown message');
        console.log(e.data);
        document.getElementById('output').innerHTML = e.data;
      }
    };
  </script>
</body>
</html>
