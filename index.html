<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h2>Angular 1.x in Web Worker</h2>
  <p>loads angular in a web worker. The loaded angular will run a digest cycle after 1 second
  and will send rendered HTML to the main browser window (here). To run, load the index.html
  using a local webserver, for example <a href="https://www.npmjs.com/package/http-server">http-server</a>.</p>
  <div id="output">rendered HTML from web worker will replace this text.</div>

  <button id="render" disabled="disabled">Render in Web Worker</button>

  <!-- angular app to send to the web worker -->
  <!--
  <script src="app-hello-world.js"></script>
  -->
  <script src="app-calendar.js"></script>
  <script src="node_modules/console-log-div/console-log-div.js"></script>
  <script>

    function checkAllDone() {
      var allDone = workers.every(function (worker) {
        return worker.done;
      });
      if (allDone) {
        console.log('all workers done');

        var html = workers.map(function (worker) {
          return worker.html;
        }).join('\n');

        document.getElementById('output').innerHTML = html;

        console.timeEnd('render');
      }
    }

    function singleWorker(k) {
      var worker = new Worker('angular-web-worker.js');

      worker.onmessage = function (e) {
        console.log('received message from angular web worker', k);
        if (e.data === 'worker-angular-ready') {
          console.log(k + ': ' + e.data);
        } else {
          // console.log('unknown message');
          // console.log(e.data);
          console.log(k + ': got result');
          // document.getElementById('output').innerHTML = e.data;
          worker.done = true;
          worker.html = e.data;
          // console.profileEnd('render');
          // console.timeEnd('render');
          checkAllDone();
        }
      };

      return worker;
    }

    console.log('trying to load angular web workers');
    var N = 4, workers = [];

    for (var k = 0; k < N; k += 1) {
      workers.push(singleWorker(k));
    }

    var button = document.getElementById('render');
    button.attributes.removeNamedItem('disabled');
    button.addEventListener('click', function () {
      console.log('sending app definition to web workers');

      if (typeof appDefinition.setupApp === 'function') {
        appDefinition.setupApp = appDefinition.setupApp.toString();
      }

      if (typeof appDefinition.renderedApp === 'function') {
        appDefinition.renderedApp = appDefinition.renderedApp.toString();
      }

      console.time('render');
      // console.profile('render');
      workers.forEach(function (worker) {
        worker.postMessage(appDefinition);
      });
    });

  </script>
</body>
</html>
